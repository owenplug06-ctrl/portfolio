---
title: "hw8"
format: 
  html:
    output-file: "index"
embed-resources: true
---

Exercise 1:

```{r}
library(vegawidget)

spec1 <- '{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "description": "Supply (Capacity) and Demand Over Time",
  "data": {
    "url": "https://calvin-data304.netlify.app/data/swd-lets-practice-ex-2-3.json"
  },
  "transform": [
    {"fold": ["capacity", "demand"], "as": ["metric", "value"]},
    {"calculate": "datetime(datum.date + \'-01\')", "as": "date_clean"}
  ],
  "mark": {"type": "line", "point": true, "strokeWidth": 2.5},
  "encoding": {
    "x": {
      "field": "date_clean", "type": "temporal", "title": "Month",
      "axis": {"format": "%b %Y", "labelAngle": -45, "labelAlign": "right"}
    },
    "y": {"field": "value", "type": "quantitative", "title": "Megawatts (MW)"},
    "color": {
      "field": "metric", "type": "nominal", "title": "Metric",
      "scale": {"domain": ["capacity", "demand"], "range": ["#4c78a8", "#f58518"]}
    }
  },
  "width": 700, "height": 400,
  "title": "Supply (Capacity) and Demand Over Time"
}'

# Graphic 3: Supply and Demand Bar Chart
spec3 <- '{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "description": "Supply and Demand Comparison (Bar Chart)",
  "data": {
    "url": "https://calvin-data304.netlify.app/data/swd-lets-practice-ex-2-3.json"
  },
  "transform": [
    {"fold": ["capacity", "demand"], "as": ["metric", "value"]},
    {"calculate": "datetime(datum.date + \'-01\')", "as": "date_clean"}
  ],
  "mark": {"type": "bar", "width": 15},
  "encoding": {
    "x": {
      "field": "date_clean", "type": "temporal", "title": "Month",
      "axis": {"format": "%b %Y", "labelAngle": -45, "labelAlign": "right"}
    },
    "y": {"field": "value", "type": "quantitative", "title": "Megawatts (MW)"},
    "color": {
      "field": "metric", "type": "nominal", "title": "Metric",
      "scale": {"domain": ["capacity", "demand"], "range": ["#4c78a8", "#f58518"]}
    },
    "xOffset": {"field": "metric"}
  },
  "width": 700, "height": 400,
  "title": "Supply and Demand Comparison"
}'

spec1 |> as_vegaspec()  # Basic lines
spec3 |> as_vegaspec()  # Bar chart
```
```{r}
library(vegawidget)

# Side-by-side bar chart comparing Demand and Capacity - CORRECTED
spec_side_by_side <- '{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "description": "Demand vs Capacity Side-by-Side Bar Chart",
  "data": {
    "url": "https://calvin-data304.netlify.app/data/swd-lets-practice-ex-2-3.json"
  },
  "transform": [
    {"fold": ["demand", "capacity"], "as": ["metric", "value"]},
    {"calculate": "datetime(datum.date + \'-01\')", "as": "date_clean"},
    {"calculate": "year(datum.date_clean)", "as": "year"},
    {"calculate": "month(datum.date_clean)", "as": "month"}
  ],
  "mark": {"type": "bar", "width": {"band": 0.8}},
  "encoding": {
    "x": {
      "field": "date_clean",
      "type": "ordinal",
      "title": "Month",
      "axis": {"labelAngle": -45, "labelAlign": "right", "format": "%b %Y"},
      "timeUnit": "yearmonth",
      "sort": {"field": "date_clean", "order": "ascending"}
    },
    "xOffset": {
      "field": "metric",
      "type": "nominal"
    },
    "y": {
      "field": "value",
      "type": "quantitative",
      "title": "Megawatts (MW)",
      "axis": {"grid": true}
    },
    "color": {
      "field": "metric",
      "type": "nominal",
      "title": "Metric",
      "scale": {
        "domain": ["demand", "capacity"],
        "range": ["#f58518", "#4c78a8"]
      },
      "legend": {"title": null, "orient": "top"}
    },
    "tooltip": [
      {"field": "date", "type": "nominal", "title": "Month"},
      {"field": "metric", "type": "nominal", "title": "Type"},
      {"field": "value", "type": "quantitative", "title": "Value", "format": ",.0f"}
    ]
  },
  "width": 700,
  "height": 400,
  "title": {
    "text": "Demand vs Capacity: Side-by-Side Comparison",
    "fontSize": 14,
    "fontWeight": "bold",
    "anchor": "start",
    "offset": 10
  }
}'

# Display the chart
spec_side_by_side |> as_vegaspec()
```
```{r}
library(vegawidget)

# Unmet Demand Line Graph
spec_unmet_demand <- '{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "description": "Unmet Demand Over Time",
  "data": {
    "url": "https://calvin-data304.netlify.app/data/swd-lets-practice-ex-2-3.json"
  },
  "transform": [
    {"calculate": "datetime(datum.date + \'-01\')", "as": "date_clean"},
    {"calculate": "datum.demand - datum.capacity", "as": "unmet_demand"}
  ],
  "mark": {
    "type": "line",
    "point": {
      "filled": true,
      "size": 80,
      "color": "#e45756",
      "stroke": "white",
      "strokeWidth": 1.5
    },
    "strokeWidth": 3,
    "color": "#e45756"
  },
  "encoding": {
    "x": {
      "field": "date_clean",
      "type": "temporal",
      "title": "Month",
      "axis": {
        "format": "%b %Y",
        "labelAngle": -45,
        "labelAlign": "right",
        "grid": false
      }
    },
    "y": {
      "field": "unmet_demand",
      "type": "quantitative",
      "title": "Unmet Demand (MW)",
      "axis": {
        "grid": true,
        "gridColor": "#e9e9e9"
      }
    },
    "tooltip": [
      {
        "field": "date",
        "type": "nominal",
        "title": "Month"
      },
      {
        "field": "demand",
        "type": "quantitative",
        "title": "Demand",
        "format": ",.0f"
      },
      {
        "field": "capacity",
        "type": "quantitative",
        "title": "Capacity",
        "format": ",.0f"
      },
      {
        "field": "unmet_demand",
        "type": "quantitative",
        "title": "Unmet Demand",
        "format": ",.0f"
      }
    ]
  },
  "width": 700,
  "height": 400,
  "title": {
    "text": "Unmet Demand Over Time (Demand - Capacity)",
    "fontSize": 14,
    "fontWeight": "bold",
    "anchor": "start",
    "offset": 10
  }
}'

# Display the chart
spec_unmet_demand |> as_vegaspec()
```
```{r}
library(vegawidget)

# Demand as thinner bar above capacity bar
spec_demand_thinner_bar <- '{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "description": "Capacity bars with thinner demand bars above",
  "data": {
    "url": "https://calvin-data304.netlify.app/data/swd-lets-practice-ex-2-3.json"
  },
  "transform": [
    {"calculate": "datetime(datum.date + \'-01\')", "as": "date_clean"},
    {"calculate": "datum.demand - datum.capacity", "as": "unmet_demand"},
    {"calculate": "datum.capacity", "as": "capacity_fill"},
    {"calculate": "if(datum.unmet_demand > 0, datum.unmet_demand, 0)", "as": "excess_demand"}
  ],
  "layer": [
{
      "mark": {"type": "bar", "width": {"band": 0.3}, "color": "#f58518"},
      "encoding": {
        "x": {
          "field": "date_clean",
          "type": "temporal",
          "timeUnit": "yearmonth"
        },
        "y": {
          "field": "demand",
          "type": "quantitative"
        }
      }
    },
    {
      "mark": {"type": "bar", "width": {"band": 0.7}, "color": "#4c78a8"},
      "encoding": {
        "x": {
          "field": "date_clean",
          "type": "temporal",
          "timeUnit": "yearmonth",
          "title": "Month",
          "axis": {"format": "%b %Y", "labelAngle": -45, "labelAlign": "right"}
        },
        "y": {
          "field": "capacity_fill",
          "type": "quantitative",
          "title": "Megawatts (MW)"
        }
      }
    }
  ],
  "width": 700,
  "height": 400,
  "title": {
    "text": "Capacity Bars (Wide) with Thinner Demand Bars Above",
    "fontSize": 14,
    "fontWeight": "bold",
    "anchor": "start",
    "offset": 10
  }
}'

# Display the chart
spec_demand_thinner_bar |> as_vegaspec()
```
```{r}
library(vegawidget)

# Only red connecting lines between demand and capacity points
spec_only_connecting_lines <- '{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "description": "Only connecting lines between demand and capacity points",
  "data": {
    "url": "https://calvin-data304.netlify.app/data/swd-lets-practice-ex-2-3.json"
  },
  "transform": [
    {"calculate": "datetime(datum.date + \'-01\')", "as": "date_clean"},
    {"calculate": "datum.demand - datum.capacity", "as": "unmet_demand"}
  ],
  "layer": [
    {
      "mark": {"type": "point", "color": "#4c78a8", "size": 100, "filled": true},
      "encoding": {
        "x": {
          "field": "date_clean",
          "type": "temporal",
          "timeUnit": "yearmonth",
          "title": "Month",
          "axis": {"format": "%b %Y", "labelAngle": -45, "labelAlign": "right"}
        },
        "y": {
          "field": "capacity",
          "type": "quantitative",
          "title": "Megawatts (MW)"
        }
      }
    },
    {
      "mark": {"type": "point", "color": "#f58518", "size": 100, "filled": true},
      "encoding": {
        "x": {
          "field": "date_clean",
          "type": "temporal",
          "timeUnit": "yearmonth"
        },
        "y": {
          "field": "demand",
          "type": "quantitative"
        }
      }
    },
    {
      "transform": [
        {"filter": "datum.demand != datum.capacity"}
      ],
      "mark": {
        "type": "rule",
        "color": "#e45756",
        "strokeWidth": 2,
        "opacity": 0.8
      },
      "encoding": {
        "x": {
          "field": "date_clean",
          "type": "temporal",
          "timeUnit": "yearmonth"
        },
        "y": {"field": "capacity", "type": "quantitative"},
        "y2": {"field": "demand", "type": "quantitative"},
        "tooltip": [
          {"field": "date", "type": "nominal", "title": "Month"},
          {"field": "capacity", "type": "quantitative", "title": "Capacity", "format": ",.0f"},
          {"field": "demand", "type": "quantitative", "title": "Demand", "format": ",.0f"},
          {"field": "unmet_demand", "type": "quantitative", "title": "Gap", "format": ",.0f"}
        ]
      }
    }
  ],
  "width": 700,
  "height": 400,
  "title": {
    "text": "Demand (Orange) and Capacity (Blue) Points with Red Connecting Lines",
    "fontSize": 14,
    "fontWeight": "bold",
    "anchor": "start",
    "offset": 10
  }
}'

# Display the chart
spec_only_connecting_lines |> as_vegaspec()
```

Exercise 2:
a.
```{r}
library(vegawidget)
'{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "width": 600,
  "height": 400,
  "data": {
    "url": "https://cdn.jsdelivr.net/npm/vega-datasets@2.8.0/data/jobs.json"
  },
  "mark": {
    "type": "line",
    "point": true
  },
  "encoding": {
    "x": {
      "field": "year",
      "type": "ordinal",
      "title": "Year"
    },
    "y": {
      "field": "perc",
      "aggregate": "sum",
      "type": "quantitative",
      "title": "Total % of Workforce"
    },
    "color": {
      "field": "sex",
      "type": "nominal",
      "title": "Sex"
    },
    "tooltip": [
      {"field": "year", "type": "ordinal"},
      {"field": "sex", "type": "nominal"},
      {"field": "perc", "aggregate": "sum", "type": "quantitative", "title": "Total %"}
    ]
  }
}' |> as_vegaspec()
```
The graphic reveals a trend towards an equal amount of men and women in the workforce. In 1850 it was almost 100% men but as time moves on the Women's share has continued to increase until it has seemingly reached a limit at around 49% which is as close to 50% without reaching it exactly. This demonstrates a trend overtime to more and more women entering the workforce probably due to cultural and political changes in the US.

b.
```{r}
library(vegawidget)
'{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "data": {
    "url": "https://cdn.jsdelivr.net/npm/vega-datasets@2.8.0/data/jobs.json"
  },
  "transform": [
    {
      "filter": {"field": "year", "oneOf": [1850, 1900, 1950, 2000]}
    },
    {
      "pivot": "sex",
      "groupby": ["job", "year"],
      "value": "perc"
    }
  ],
  "facet": {
    "field": "year",
    "type": "ordinal",
    "title": "Year"
  },
  "columns": 2,
  "spec": {
    "width": 250,
    "height": 250,
    "mark": {"type": "point", "tooltip": true},
    "encoding": {
      "x": {
        "field": "men",
        "type": "quantitative",
        "title": "Men",
        "axis": {"format": ".0%"}
      },
      "y": {
        "field": "women",
        "type": "quantitative",
        "title": "Women",
        "axis": {"format": ".0%"}
      },
      "tooltip": [
        {"field": "job", "type": "nominal", "title": "Job"},
        {"field": "men", "type": "quantitative", "title": "Men", "format": ".0%"},
        {"field": "women", "type": "quantitative", "title": "Women", "format": ".0%"}
      ]
    }
  }
}'|> as_vegaspec()
```


c.
```{r}
library(vegawidget)
'{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "data": {
    "url": "https://cdn.jsdelivr.net/npm/vega-datasets@2.8.0/data/jobs.json"
  },
  "transform": [
    {
      "filter": {"field": "year", "oneOf": [1850, 1900, 1950, 2000]}
    },
    {
      "joinaggregate": [{"op": "sum", "field": "count", "as": "total_count_job"}],
      "groupby": ["job", "year"]
    },
    {
      "calculate": "datum.count / datum.total_count_job",
      "as": "perc_within_job"
    }
  ],
  "facet": {
    "field": "year",
    "type": "ordinal",
    "title": "Year"
  },
  "columns": 2,
  "spec": {
    "width": 300,
    "height": 400,
    "mark": {"type": "point", "tooltip": true},
    "encoding": {
      "x": {
        "field": "perc_within_job",
        "type": "quantitative",
        "title": "Percent Within Job",
        "axis": {"format": ".0%"}
      },
      "y": {
        "field": "job",
        "type": "nominal",
        "title": "Job",
        "sort": "-x",
        "axis": {"labels": false}
      },
      "color": {
        "field": "sex",
        "type": "nominal",
        "title": "Sex",
        "scale": {
          "domain": ["men", "women"],
          "range": ["#1f77b4", "#e377c2"]
        }
      },
      "tooltip": [
        {"field": "job", "type": "nominal", "title": "Job"},
        {"field": "sex", "type": "nominal", "title": "Sex"},
        {"field": "perc_within_job", "type": "quantitative", "title": "Percent", "format": ".0%"}
      ]
    }
  }
}' |> as_vegaspec()
```


Exercise 3:

```{r}
#| message: false
#| warning: false

library(tidyverse)
library(vegawidget)
library(countrycode)

# Wrangle - use values_transform to force all year columns to numeric
gas <- read_csv("pump_price_for_gasoline_us_per_liter.csv") |>
  pivot_longer(-country, names_to = "year", values_to = "price_per_liter",
               values_transform = list(price_per_liter = as.numeric)) |>
  mutate(
    year = as.integer(year),
    price_per_gallon = price_per_liter * 3.78541,
    iso3  = countrycode(country, "country.name", "iso3c"),
    region = countrycode(country, "country.name", "region")
  ) |>
  filter(year == 2016)

# Vega-Lite spec as JSON string
spec_json <- paste0('{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "title": {
    "text": "Gas Prices by Country (2016)",
    "subtitle": "USD per gallon. Each dot is one country; hover for details."
  },
  "width": 700,
  "height": 400,
  "data": {"values": ', jsonlite::toJSON(gas, auto_unbox = TRUE), '},
  "mark": {"type": "point", "filled": true, "opacity": 0.8},
  "encoding": {
    "x": {
      "field": "price_per_gallon",
      "type": "quantitative",
      "title": "Price (USD per gallon)",
      "axis": {"format": "$,.2f"}
    },
    "y": {
      "field": "region",
      "type": "nominal",
      "title": "Region",
      "sort": "-x"
    },
    "color": {
      "field": "region",
      "type": "nominal",
      "legend": null
    },
    "tooltip": [
      {"field": "country", "type": "nominal", "title": "Country"},
      {"field": "iso3", "type": "nominal", "title": "Code"},
      {"field": "region", "type": "nominal", "title": "Region"},
      {"field": "price_per_gallon", "type": "quantitative", "title": "$/gallon", "format": "$,.2f"}
    ]
  }
}')

as_vegaspec(spec_json)
```

From the graphic as there is no Null row it appears that every country was givin a continent so no NA values were givin for continent.